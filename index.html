<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <style>
        body {
            margin:0;
            padding:0;
            margin-top:25px;
            background-color:black;
            color:whitesmoke;
            text-shadow:1px 6px 4px rgb(253, 11, 249);
        }
        .controls {
            margin:auto;
            width:80%;  
            text-align:center;  
        }
        button {
            font-size:calc(10vw);
            font-style: italic;
            background-color:transparent;
            border-color:whitesmoke;
            border-radius:1000px;
            border-style:solid;
            border-width:1px; 
            height:25%;
            width:100%;
            cursor:pointer;
            color:whitesmoke;
            box-shadow:1px 6px 8px rgb(253, 11, 249);
        }
        p{
            font-family: 'Courier New', Courier, monospace;
        }
        video{
          border-radius:10000px;
          position:absolute;
          z-index:-1;
        }

    </style>
    <script type="text/javascript" src="https://cdn.cycling74.com/rnbo/latest/rnbo.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      let socket = io();
      let el;
      let videoEl;
      let buttonEl;
      let vFile = 'www.thomasjohnmartinez.com/videos/wavesandparticlestrue.mp4';
      let windText = ['wind', 'blow', 'gust'];
      let vFiles = ['https://www.thomasjohnmartinez.com/videos/chime.mov_1.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_2.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_3.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_4.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_5.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_6.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_7.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_8.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_9.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_10.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_11.mp4','https://www.thomasjohnmartinez.com/videos/chime.mov_12.mp4'];
      function getRandomInt(max) {
        return Math.floor(Math.random() * max);
      }

      const min = 0;
      const max = window.innerWidth - 320;

      // Clamp number between two values with the following line:
      const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

      const { createDevice } = RNBO;
      let context;
      const WAContext = window.AudioContext || window.webkitAudioContext;
      context = new WAContext();
      async function setup2() {
        const WAContext = window.AudioContext || window.webkitAudioContext;
        context = new WAContext();
        // Create gain node and connect it to audio output
        const outputNode = context.createGain();
        outputNode.connect(context.destination);
        
        // Fetch the exported patchers  
        let response = await fetch('rnbo.filterdelay.json');
        console.log(response);
        const delayPatcher = await response.json();
        
        response = await fetch('rnbo.platereverb.json');
        const reverbPatcher = await response.json();
      
        // Create the devices
        const delayDevice = await createDevice({ context, patcher: delayPatcher });
        const reverbDevice = await createDevice({ context, patcher: reverbPatcher });
        
        // Connect the devices in series
        videoEl = document.getElementById('lumi');
        const source = context.createMediaElementSource(videoEl);
        source.connect(delayDevice);
        delayDevice.node.connect(reverbDevice.node);
        reverbDevice.node.connect(outputNode);   
        //get parameters   
      }

      const setup = async () => {
        let rawPatcher = await fetch('rnbo.filterdelay.json');
        let patcher = await rawPatcher.json();

        let device = await createDevice({ context, patcher });

        // This connects the device to audio output, but you may still need to call context.resume()
        // from a user-initiated function.
        device.node.connect(context.destination);
      };
      setup();
      socket.on('time', (timeString) => {
        el = document.getElementById('server-time');
        el.innerHTML = 'Server time: ' + timeString;
      });

      socket.on('response', (controller) => {
        el = document.getElementById('gust-state');
        el.innerHTML = 'a new gust was initiated at ' +new Date().toTimeString();
        farocki();
      });

      function farocki() {
        videoEl = document.getElementById('lumi');
        buttonEl = document.getElementById('buttonText');
        videoEl.style.left = clamp((Math.random() * window.innerWidth), min, max) +'px';
        videoEl.style.top = (Math.random() * window.innerHeight - 90) +'px';
        buttonEl.innerHTML = windText[getRandomInt(windText.length)];
        videoEl.src =  vFiles[getRandomInt(vFiles.length)];
        videoEl.play();
        //const source = context.createMediaElementSource(videoEl);    
      }

      function gust(){
        socket.emit("controller", "gust");
        videoEl = document.getElementById('lumi');
        context.start();
        videoEl.muted = false; 
      }

      function stop(){
        videoEl = document.getElementById('lumi');
        videoEl.pause();
        videoEl.src=null;
        //socket.emit("stop", "now");
      }

    </script>
  </head>
  <body>
    <div class="controls">
        <h1 style='font-family:cursive'>the invisible hand</h1>
        <p>a multi-user instrument</p>
        <p>click the button to control the wind-chime</p>
        <button id = "buttonText" onclick="gust()">wind</button>
        </br>
        </br>
        <button id = "buttonStop" onclick="stop()">shhh</button>
        </br>
        </br>
        <p id="gust-state">the gust state</p> 
        <video autoplay muted loop playsinline id="lumi" ></video>        
  </body>
</html>
